<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>AUCS - Become a Member</title>

    <!-- Bootstrap core CSS --> 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
 
    <!-- Custom styles for this template -->
    <link href="main.css" rel="stylesheet">
  </head>

  <body>
    <div id="fb-root"></div>
    <script>
      // This is called with the results from from FB.getLoginStatus().
      function statusChangeCallback(response) {
        console.log('statusChangeCallback');
        console.log(response);
        // The response object is returned with a status field that lets the
        // app know the current login status of the person.
        // Full docs on the response object can be found in the documentation
        // for FB.getLoginStatus().
        if (response.status === 'connected') {
          var url = 'http://aucsmembershiphandler.azurewebsites.net/api/Current/';
          $.ajax({
            url: url,
            type: 'POST',
            headers: {
              "Token": response.authResponse.accessToken
            },
            success: function( data ) {
                $('#results').show();
                $('#loading_spinner').hide();
                $("#name").html(data.Name);
                if (data.StudentId != null) {
                  $("#student_id").html("Your Student Id is confirmed as: " + data.StudentId + ".");                  
                }
                if (data.EmailAddress != null) {
                  $("#email_address").html("You have opted in to recieve our newsletter at " + data.EmailAddress + ".");
                }
                if (data.MembershipType != null) {
                  if (data.MembershipType === "Pending") {
                    $('#pending').show();
                  } else if (data.MembershipType === "Standard") {
                    $("#membership_type").html("You have a standard membership with the AUCS. Upgrade to premium below.");
                  } else if (data.MembershipType === "Premium") {
                    $("#membership_type").html("You have a premium membership with the AUCS.");
                  } else if (data.MembershipType === "Lifetime") {
                    $("#membership_type").html("You have a lifetime membership with the AUCS.");
                  }
                }
                if (data.CommitteeTitle != null) {
                  if (data.CommitteeTitle === "General Member") {
                    $("#committee_title").html("You are on the committee as a General Member.");
                  }
                  else {
                    $("#committee_title").html("You are on the committee as the " + data.CommitteeTitle + ".");
                  }
                }            
            },
            error: function( xhr, err ) {
              if (xhr.responseJSON != null) {
                $("#form_api_response").html(xhr.responseJSON.Message);
                $('#response_modal').modal('show');
              }
              else {
                $("#form_api_response").html(err);
                $('#response_modal').modal('show');
              }
            }
          });
        } else {
          window.location.replace("current.html");
        }
      }
      // This function is called when someone finishes with the Login
      // Button.  See the onlogin handler attached to it in the sample
      // code below.
      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      }

      window.fbAsyncInit = function() {
        FB.init({
          appId      : '631831156964129',
          cookie     : true,  // enable cookies to allow the server to access 
                              // the session
          xfbml      : true,  // parse social plugins on this page
          version    : 'v2.6' // use graph api version 2.5
        });

        // Now that we've initialized the JavaScript SDK, we call 
        // FB.getLoginStatus().  This function gets the state of the
        // person visiting this page and can return one of three states to
        // the callback you provide.  They can be:
        //
        // 1. Logged into your app ('connected')
        // 2. Logged into Facebook, but not your app ('not_authorized')
        // 3. Not logged into Facebook and can't tell if they are logged into
        //    your app or not.
        //
        // These three cases are handled in the callback function.

        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      };

      // Load the SDK asynchronously
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    </script>
    <div class="site-wrapper">
      <div class="site-wrapper-inner">
        <div class="cover-container">
          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand">AUCS</h3>
              <nav>
                <ul class="nav masthead-nav">
                  <li><a href="index.html">Home</a></li>
                  <!--<li><a href="cheeses.html">Cheeses</a></li>-->
                  <!--<li><a href="#">About</a></li>-->
                </ul>
              </nav>
            </div>
          </div>
          
          <div class="spacer"></div>
          
          <div class="inner cover form-wrapper">
            <h2>Become a Member</h2>
            <div class="panel panel-default">
              <div id="loading_spinner" class="panel-body">
                <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>
              </div>
              <div id="pending" class="panel-body">
                <p class="lead">Your membership status is pending.</p>
                <p>Unfortunately due to AUU regulations at least 50% of our members must be Adelaide University students. If you are a student please provide your Student Id below to confirm your membership. If you are not a student hang in there, your membership will be confirmed when a place becomes available.</p>
              </div>
              <div id="results" class="panel-body">
                <p>Hi <span id="name"></span>!</p>
                <p><span id="committee_title"></span></p>
                <p><span id="membership_type"></span></p>
                <p><span id="student_id">You haven't provided an Adelaide Uni Student Id.</span></p>
                <p><span id="email_address">You opted in to our email newsletter.</span></p>
              </div>
            </div>
            <div id="status"></div>
          </div>

          <div class="mastfoot">
            <div class="inner">
              <p>&copy; 2016 Adelaide University Cheese Society</p>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="response_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header"></div>
          <div class="modal-body">
            <p id="form_api_response"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Bootstrap core JavaScript -->
    <!-- ================================================== --> 
    <!-- Placed at the end of the document so the pages load faster --> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> 
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> 
    <script>
      $('#results').hide();
      $('#pending').hide();  
    </script>
  </body>
</html>